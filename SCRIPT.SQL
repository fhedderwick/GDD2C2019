USE GD2C2019
GO

--DROP CONSTRAINTS (FKs)

ALTER TABLE [MANA].FACTURA DROP CONSTRAINT FK_PROV_ID;
ALTER TABLE [MANA].FACTURA DROP CONSTRAINT FK_OF_FACT_ID; 
ALTER TABLE [MANA].CONSUMO_OFERTA DROP CONSTRAINT FK_CUPON_ID; 
ALTER TABLE [MANA].CARGA_CREDITO DROP CONSTRAINT FK_CLI_ID;
ALTER TABLE [MANA].COMPRA_OFERTA DROP CONSTRAINT FK_OF_ID; 
ALTER TABLE [MANA].COMPRA_OFERTA DROP CONSTRAINT FK_CLIENTE_ID; 
ALTER TABLE [MANA].OFERTA DROP CONSTRAINT FK_CUP_ID; 
ALTER TABLE [MANA].OFERTA DROP CONSTRAINT FK_PROVEEDOR_ID; 
ALTER TABLE [MANA].USUARIO_ROL DROP CONSTRAINT FK_USER_ID; 
ALTER TABLE [MANA].USUARIO_ROL DROP CONSTRAINT FK_ROL_ID; 
ALTER TABLE [MANA].FUNCIONALIDAD_ROL DROP CONSTRAINT FK_R_ID; 
ALTER TABLE [MANA].FUNCIONALIDAD_ROL DROP CONSTRAINT FK_FUNC_ID;

--DROP TABLES
IF OBJECT_ID('MANA.PROVEEDOR') IS NOT NULL
DROP TABLE MANA.PROVEEDOR;
IF OBJECT_ID('MANA.FACTURA') IS NOT NULL
DROP TABLE MANA.FACTURA;
IF OBJECT_ID('MANA.OFERTA_FACTURADA') IS NOT NULL
DROP TABLE MANA.OFERTA_FACTURADA;
IF OBJECT_ID('MANA.USUARIO') IS NOT NULL
DROP TABLE MANA.USUARIO;
IF OBJECT_ID('MANA.CONSUMO_OFERTA') IS NOT NULL
DROP TABLE MANA.CONSUMO_OFERTA;
IF OBJECT_ID('MANA.CLIENTE') IS NOT NULL
DROP TABLE MANA.CLIENTE;
IF OBJECT_ID('MANA.CARGA_CREDITO') IS NOT NULL
DROP TABLE MANA.CARGA_CREDITO;
IF OBJECT_ID('MANA.COMPRA_OFERTA') IS NOT NULL
DROP TABLE MANA.COMPRA_OFERTA;
IF OBJECT_ID('MANA.OFERTA') IS NOT NULL
DROP TABLE MANA.OFERTA;
IF OBJECT_ID('MANA.CUPON') IS NOT NULL
DROP TABLE MANA.CUPON;
IF OBJECT_ID('MANA.USUARIO_ROL') IS NOT NULL
DROP TABLE MANA.USUARIO_ROL;
IF OBJECT_ID('MANA.ROL') IS NOT NULL
DROP TABLE MANA.ROL;
IF OBJECT_ID('MANA.FUNCIONALIDAD_ROL') IS NOT NULL
DROP TABLE MANA.FUNCIONALIDAD_ROL;
IF OBJECT_ID('MANA.FUNCIONALIDAD') IS NOT NULL
DROP TABLE MANA.FUNCIONALIDAD;


IF EXISTS(SELECT NAME FROM SYS.SCHEMAS WHERE NAME='MANA')
DROP SCHEMA MANA
GO

/** CREACION DE ESQUEMA **/
CREATE SCHEMA MANA --AUTHORIZATION gdCupon2019
GO

--------------------------------------------------------------------------------------

/** CREACION DE TABLAS **/

CREATE TABLE [MANA].PROVEEDOR (
	PROV_ID INT NOT NULL IDENTITY,
	PROV_RAZON_SOCIAL VARCHAR(20),
	PROV_CUIT VARCHAR(20),
	PROV_MAIL VARCHAR(20),
	PROV_TELEFONO VARCHAR(20),
	PROV_DIRECCION VARCHAR(20),	
	PROV_CIUDAD VARCHAR(20),
	PROV_RUBRO VARCHAR(20),
	PROV_ESTADO VARCHAR(20),
	
	CONSTRAINT PROV_PK PRIMARY KEY (PROV_ID)
);

CREATE TABLE [MANA].FACTURA (
	FACT_ID INT NOT NULL IDENTITY,
	FACT_FECHA DATE,	
	FACT_PROVEEDOR_ID INT,
	FACT_OF_FACT_ID INT,
	FACT_IMPORTE INT,
	
	CONSTRAINT FACT_PK PRIMARY KEY (FACT_ID)
);

CREATE TABLE [MANA].OFERTA_FACTURADA (
    OF_FACT_ID INT NOT NULL IDENTITY,
	OF_FACT_COMPRA_OFERTA_ID INT

	CONSTRAINT OFFACT_PK PRIMARY KEY (OF_FACT_ID)
);

CREATE TABLE [MANA].USUARIO (
	USER_ID INT NOT NULL IDENTITY,
	USER_USERNAME VARCHAR(20),
	USER_PASSWORD VARCHAR(20),
	USER_INTENTOS_FALLIDOS INT,
	USUARIO_ESTADO INT NOT NULL DEFAULT 0,
	
	CONSTRAINT USER_PK PRIMARY KEY (USER_ID)
);

CREATE TABLE [MANA].CONSUMO_OFERTA (
	CONSOF_ID INT NOT NULL IDENTITY,
	CONSOF_FECHA_ENTREGA DATE,
	CONSOF_CUPON_ID INT,
	CONSOF_CLIENTE_DEST_NOMBRE VARCHAR(20),
	CONSOF_CLIENTE_DEST_APELLIDO VARCHAR(20),
	CONSOF_CLIENTE_DEST_DNI INT,
	CONSOF_CLIENTE_DEST_MAIL VARCHAR(20),
	CONSOF_CLIENTE_DEST_TELEFONO VARCHAR(20),
	CONSOF_CLIENTE_DEST_DIRECCION VARCHAR(20),
	CONSOF_CLIENTE_DEST_FECHA_NACIMIENTO DATE,
	CONSOF_CLIENTE_DEST_CIUDAD VARCHAR(20),

	CONSTRAINT CONSOF_PK PRIMARY KEY (CONSOF_ID)
);

CREATE TABLE [MANA].CLIENTE (
	CLI_ID INT NOT NULL IDENTITY,
	CLI_NOMBRE VARCHAR(20),
	CLI_APELLIDO VARCHAR(20),
	CLI_DNI VARCHAR(20),
	CLI_MAIL VARCHAR(20),
	CLI_TELEFONO VARCHAR(20),
	CLI_DIRECCION VARCHAR(20),
	CLI_CIUDAD VARCHAR(20),
	CLI_FECHA_NACIMIENTO DATE,
	CLI_ESTADO VARCHAR(20),
	
	CONSTRAINT CLI_PK PRIMARY KEY (CLI_ID)
);

CREATE TABLE [MANA].CARGA_CREDITO (
	CC_ID INT NOT NULL IDENTITY,
	CC_FECHA_CARGA DATE,
	CC_CLIENTE_ID INT,
	CC_TIPO_PAGO VARCHAR(20),
	CC_MONTO INT,
	CC_NUMERO_TARJETA VARCHAR(20),
	
	CONSTRAINT CC_PK PRIMARY KEY (CC_ID)
);

CREATE TABLE [MANA].COMPRA_OFERTA (
	COMPOF_ID INT NOT NULL IDENTITY,
	COMPOF_FECHA_COMPRA DATE,
	COMPOF_OFERTA_ID INT,
	COMPOF_CLIENTE_ID INT,
	
    CONSTRAINT COMPOF_PK PRIMARY KEY (COMPOF_ID)
);

CREATE TABLE [MANA].OFERTA (
	OF_ID INT NOT NULL IDENTITY,
	OF_DESCRIPCION VARCHAR(20),
	OF_FECHA_PUBLICACION DATE,
	OF_FECHA_VENCIMIENTO DATE,
	OF_CUPON_ID INT,
	OF_PROVEEDOR_ID INT,
	OF_CANTIDAD_DISPONIBLE INT,
	OF_ESTADO VARCHAR(20),
	
	CONSTRAINT OF_PK PRIMARY KEY (OF_ID)
);

CREATE TABLE [MANA].CUPON (
	CUPON_ID INT NOT NULL IDENTITY,
	CUPON_PRECIO_OFERTA INT,
	CUPON_PRECIO_LISTA INT,
	CUPON_ESTADO VARCHAR(20),
	
	CONSTRAINT CUPON_PK PRIMARY KEY (CUPON_ID)
);

CREATE TABLE [MANA].USUARIO_ROL (
	UR_USR_ID INT,
	UR_ROL_ID INT,
	
	CONSTRAINT UR_PK PRIMARY KEY (UR_USR_ID,UR_ROL_ID)
);

CREATE TABLE [MANA].ROL (
	ROL_ID INT NOT NULL IDENTITY,
	ROL_NOMBRE VARCHAR(20),
	ROL_ESTADO VARCHAR(20),
	
	CONSTRAINT ROL_PK PRIMARY KEY (ROL_ID)
);

CREATE TABLE [MANA].FUNCIONALIDAD_ROL (
	FR_ROL_ID INT,
	FR_FUNCIONALIDAD_ID INT,
	
	CONSTRAINT FR_PK PRIMARY KEY (FR_ROL_ID,FR_FUNCIONALIDAD_ID)
);

CREATE TABLE [MANA].FUNCIONALIDAD (
	FUNC_ID INT NOT NULL IDENTITY,
	FUN_NOMBRE VARCHAR(20),
	
	CONSTRAINT FUNC_PK PRIMARY KEY (FUNC_ID)
);

--------------------------------------------------------------------------------------

ALTER TABLE [MANA].FACTURA ADD CONSTRAINT FK_PROV_ID FOREIGN KEY (FACT_PROVEEDOR_ID) REFERENCES [MANA].PROVEEDOR (PROV_ID);
ALTER TABLE [MANA].FACTURA ADD CONSTRAINT FK_OF_FACT_ID FOREIGN KEY (FACT_OF_FACT_ID) REFERENCES [MANA].OFERTA_FACTURADA (OF_FACT_ID);
ALTER TABLE [MANA].CONSUMO_OFERTA ADD CONSTRAINT FK_CUPON_ID FOREIGN KEY (CONSOF_CUPON_ID) REFERENCES [MANA].CUPON (CUPON_ID);
ALTER TABLE [MANA].CARGA_CREDITO ADD CONSTRAINT FK_CLI_ID FOREIGN KEY (CC_CLIENTE_ID) REFERENCES [MANA].CLIENTE (CLI_ID);
ALTER TABLE [MANA].COMPRA_OFERTA ADD CONSTRAINT FK_OF_ID FOREIGN KEY (COMPOF_OFERTA_ID) REFERENCES [MANA].OFERTA (OF_ID);
ALTER TABLE [MANA].COMPRA_OFERTA ADD CONSTRAINT FK_CLIENTE_ID FOREIGN KEY (COMPOF_CLIENTE_ID) REFERENCES [MANA].CLIENTE (CLI_ID);
ALTER TABLE [MANA].OFERTA ADD CONSTRAINT FK_CUP_ID FOREIGN KEY (OF_CUPON_ID) REFERENCES [MANA].CUPON (CUPON_ID);
ALTER TABLE [MANA].OFERTA ADD CONSTRAINT FK_PROVEEDOR_ID FOREIGN KEY (OF_PROVEEDOR_ID) REFERENCES [MANA].PROVEEDOR (PROV_ID);
ALTER TABLE [MANA].USUARIO_ROL ADD CONSTRAINT FK_USER_ID FOREIGN KEY (UR_USR_ID) REFERENCES [MANA].USUARIO (USER_ID);
ALTER TABLE [MANA].USUARIO_ROL ADD CONSTRAINT FK_ROL_ID FOREIGN KEY (UR_ROL_ID) REFERENCES [MANA].ROL (ROL_ID);
ALTER TABLE [MANA].FUNCIONALIDAD_ROL ADD CONSTRAINT FK_R_ID FOREIGN KEY (FR_ROL_ID) REFERENCES [MANA].ROL (ROL_ID);
ALTER TABLE [MANA].FUNCIONALIDAD_ROL ADD CONSTRAINT FK_FUNC_ID FOREIGN KEY (FR_FUNCIONALIDAD_ID) REFERENCES [MANA].FUNCIONALIDAD (FUNC_ID);
GO 

/** MIGRACION **/

/*Cliente*/
/*
INSERT [MANA].CLIENTE(CLI_NOMBRE, CLI_APELLIDO, CLI_DNI, CLI_MAIL, CLI_TELEFONO, CLI_DIRECCION, CLI_CIUDAD, CLI_FECHA_NACIMIENTO, CLI_ESTADO)
 SELECT DISTINCT Cli_Nombre, Cli_Apellido, Cli_Dni, Cli_Mail, Cli_Telefono, Cli_Direccion, Cli_Ciudad, Cli_Fecha_Nac, 'Habilitado' 
 FROM gd_esquema.Maestra
 GO
*/
