USE GD2C2019
GO
IF EXISTS(SELECT NAME FROM SYS.SCHEMAS
WHERE NAME='MANA') BEGIN

--DROP CONSTRAINTS (FKs)
DROP CONSTRAINT FK_PROV_ID;


--DROP TABLES
DROP TABLE MANA.PROVEEDOR;
DROP TABLE MANA.CUPON;
DROP TABLE MANA.OFERTAS;
DROP TABLE MANA.COMPRA_OFERTA;
DROP TABLE MANA.CARGA_CREDITO;
DROP TABLE MANA.CLIENTE;
DROP TABLE MANA.CONSUMO_OFERTAS;
DROP TABLE MANA.USUARIO;
DROP TABLE MANA.FACTURACION;
DROP TABLE MANA.USUARIO_ROL;
DROP TABLE MANA.ROL;
DROP TABLE MANA.FUNCIONALIDAD_ROL;
DROP TABLE MANA.FUNCIONALIDAD;

DROP SCHEMA MANA END

GO
CREATE SCHEMA MANA --AUTHORIZATION gdCupon2019
GO

--------------------------------------------------------------------------------------

CREATE TABLE [MANA].PROVEEDOR (
	PROV_ID INT NOT NULL IDENTITY,
	PROV_RAZON_SOCIAL VARCHAR(20),
	PROV_CUIT VARCHAR(20),
	PROV_MAIL VARCHAR(20),
	PROV_TELEFONO VARCHAR(20),
	PROV_DIRECCION VARCHAR(20),
	PROV_CODIGO_POSTAL VARCHAR(20),
	PROV_CIUDAD VARCHAR(20),
	PROV_RUBRO VARCHAR(20),
	PROV_NOMBRE VARCHAR(20),
	PROB_ESTADO VARCHAR(20),
	
	CONSTRAINT PROV_PK PRIMARY KEY (PROV_ID)
);

CREATE TABLE [MANA].FACTURACION (
	FACT_ID INT NOT NULL IDENTITY,
	FACT_FECHA_INICIO DATE,
	FACT_FECHA_FINAL DATE,
	FACT_PROVEEDOR_ID INT,
	FACT_LISTA_OFERTAS VARCHAR(20),
	FACT_IMPORTE INT,
	
	CONSTRAINT FACT_PK PRIMARY KEY (FACT_ID)
);

CREATE TABLE [MANA].USUARIO (
	USER_ID INT NOT NULL IDENTITY,
	USER_USERNAME VARCHAR(20),
	USER_PASSWORD VARCHAR(20),
	USER_INTENTOS_FALLIDOS INT,
	USUARIO_ESTADO INT NOT NULL DEFAULT 0,
	
	CONSTRAINT USER_PK PRIMARY KEY (USER_ID)
);

CREATE TABLE [MANA].CONSUMO_OFERTAS (
	CONSOF_ID INT NOT NULL IDENTITY,
	CONSOF_FECHA_CONSUMO DATE,
	CONSOF_CUPON_ID INT,
	CONSOF_CLIENTE_ID INT,
	
	CONSTRAINT CONSOF_PK PRIMARY KEY (CONSOF_ID)
);

CREATE TABLE [MANA].CLIENTE (
	CLI_ID INT NOT NULL IDENTITY,
	CLI_NOMBRE VARCHAR(20),
	CLI_APELLIDO VARCHAR(20),
	CLI_DNI VARCHAR(20),
	CLI_MAIL VARCHAR(20),
	CLI_TELEFONO VARCHAR(20),
	CLI_DIRECCION VARCHAR(20),
	CLI_CODIGO_POSTAL VARCHAR(20),
	CLI_FECHA_NACIMIENTO DATE,
	CLI_ESTADO VARCHAR(20),
	
	CONSTRAINT CLI_PK PRIMARY KEY (CLI_ID)
);

CREATE TABLE [MANA].CARGA_CREDITO (
	CC_ID INT NOT NULL IDENTITY,
	CC_FECHA DATE,
	CC_CLIENTE_ID INT,
	CC_TIPO_PAGO VARCHAR(20),
	CC_MONTO INT,
	CC_NUMERO_TARJETA VARCHAR(20),
	CC_NUMERO_SEGURIDAD_TARJETA VARCHAR(20)
	
	CONSTRAINT CC_PK PRIMARY KEY (CC_ID)
);

CREATE TABLE [MANA].COMPRA_OFERTA (
	COMPOF_ID INT NOT NULL IDENTITY,
	COMPOF_FECHA_COMPRA DATE,
	COMPOF_OFERTAS_ID INT,
	COMPOF_CLIENTE_ID INT,
	
	CONSTRAINT COMPOF_PK PRIMARY KEY (COMPOF_ID)
);

CREATE TABLE [MANA].OFERTAS (
	OF_ID INT NOT NULL IDENTITY,
	OF_DESCRIPCION VARCHAR(20),
	OF_FECHA_PUBLICACION DATE,
	OF_FECHA_VENCIMIENTO DATE,
	OF_CUPON_ID INT,
	OF_PROVEEDOR_ID INT,
	OF_CANTIDAD_DISPONIBLE INT,
	OF_ESTADO VARCHAR(20),
	
	CONSTRAINT OF_PK PRIMARY KEY (OF_ID)
);

CREATE TABLE [MANA].CUPON (
	CUPON_ID INT NOT NULL IDENTITY,
	CUPON_PRECIO_OFERTA INT,
	CUPON_PRECIO_LISTA INT,
	CUPON_ESTADO VARCHAR(20),
	
	CONSTRAINT CUPON_PK PRIMARY KEY (CUPON_ID)
);

CREATE TABLE [MANA].USUARIO_ROL (
	UR_USR_ID INT,
	UR_ROL_ID INT,
	
	CONSTRAINT UR_PK PRIMARY KEY (UR_USR_ID,UR_ROL_ID)
);

CREATE TABLE [MANA].ROL (
	ROL_ID INT NOT NULL IDENTITY,
	ROL_NOMBRE VARCHAR(20),
	ROL_ESTADO VARCHAR(20),
	
	CONSTRAINT ROL_PK PRIMARY KEY (ROL_ID)
);

CREATE TABLE [MANA].FUNCIONALIDAD_ROL (
	FR_ROL_ID INT,
	FR_FUNCIONALIDAD_ID INT,
	
	CONSTRAINT FR_PK PRIMARY KEY (FR_ROL_ID,FR_FUNCIONALIDAD_ID)
);

CREATE TABLE [MANA].FUNCIONALIDAD (
	FUNC_ID INT NOT NULL IDENTITY,
	FUN_NOMBRE VARCHAR(20),
	
	CONSTRAINT FUNC_PK PRIMARY KEY (FUNC_ID)
);

--------------------------------------------------------------------------------------

ALTER TABLE [MANA].FACTURACION ADD CONSTRAINT FK_PROV_ID FOREIGN KEY (FACT_PROVEEDOR_ID) REFERENCES [MANA].PROVEEDOR (PROV_ID);